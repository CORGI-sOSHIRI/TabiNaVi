<!-- ä¿®æ­£å¾Œã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã—ãŠã‚Šè©³ç´°</title>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">

  <!-- OGPï¼ˆLINEã‚„Twitterã«ãƒªãƒ³ã‚¯è²¼ã‚‹ã¨ãã®ã‚«ãƒ¼ãƒ‰æƒ…å ±ï¼‰ -->
  <meta property="og:title" content="ãŸã³NaVi">
  <meta property="og:description" content="ã—ãŠã‚Šã‚’ä½œã£ã¦æ—…ã‚’ã‚‚ã£ã¨æ¥½ã—ãï¼">
  <meta property="og:image" content="https://staging.d3mfjfwilpc96w.amplifyapp.com/logo.png">
  <meta property="og:url" content="https://staging.d3mfjfwilpc96w.amplifyapp.com">
  <meta property="og:type" content="website">
  
  <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
  <link rel="icon" href="logo_ãŸã³ãªã³.png" type="image/png">
  <link rel="apple-touch-icon" href="logo_ãŸã³ãªã³.png">
  <link rel="apple-touch-icon-precomposed" href="logo_ãŸã³ãªã³.png">
  <link rel="shortcut icon" href="logo_ãŸã³ãªã³.png" type="image/png">
  
  <style>
    body {
      font-family: 'Zen Maru Gothic', 'Kiwi Maru', sans-serif;
      margin: 0;
      padding: 10px;
      max-width: 480px;
      margin: auto;
      background-color: #fff;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      height: 100px;
    }
    .trip-title {
      font-size: 25px;
      padding: 10px 3px;
      border-bottom: 2px solid #333;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 5px;
    }
    .tab {
      padding: 5px 10px;
      border: 2px solid #000;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background-color: #dcdcdc;
      font-weight: bold;
      cursor: pointer;
    }
    .tab.active { background-color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .shiori-box {
      position: relative;
      background-color: #ffffff;
      border: 2px solid #000;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
      min-height: 400px;

      /* èƒŒæ™¯ã®ç”»åƒã¯é€æ˜ãƒœãƒƒã‚¯ã‚¹ã§æ‰±ã† */
      overflow: hidden;
    }

    .shiori-box::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('images/corgi_placeholder.png'); /* æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã«ã™ã‚‹ */
      background-repeat: no-repeat;
      background-position: center bottom;
      background-size: contain;
      filter: opacity(0.2); /* â† èƒŒæ™¯ç”»åƒã ã‘ã‚’è–„ãï¼ */
      z-index: 0;
      pointer-events: none;
    }

    .shiori-box > * {
      position: relative;
      z-index: 1; /* æ–‡å­—ã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰é¢ã«å‡ºã™ */
    }


    .edit-icon-button {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 0;
      background: #c5c3bf;
      cursor: pointer;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      z-index: 10;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timeline {
      margin-left: 20px;
      border-left: 2px solid black;
      padding-left: 15px;
    }
    .timeline-entry {
      position: relative;
      margin-bottom: 20px;
    }
    .timeline-entry::before {
      content: '';
      position: absolute;
      left: -21px;
      top: 3px;
      width: 10px;
      height: 10px;
      background-color: #003344;
      border-radius: 50%;
    }
    .entry-label {
      color: #003344;
      text-decoration: underline;
      cursor: pointer;
    }
    .back-button {
      display: block;
      margin: 0 auto;
      background-color: white;
      border: 2px solid black;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 50;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      max-width: 80%;
      margin: 15% auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .share_button {
      border: 2px solid #0f1618;
      border-radius: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }
    #addModal textarea {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo_ãŸã³ãªã³.png" class="logo" alt="ãƒ­ã‚´">
    <div class="trip-title"></div>
    <img src="images/share_logo.png" class="share_button" id="shareButton" alt="å…±æœ‰">
  </div>

  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>ã—ãŠã‚Šã‚’å…±æœ‰</h3>
      <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š</label><br>
      <input type="email" id="shareEmail" placeholder="example@example.com"><br><br>
      <button onclick="sendShare()">é€ä¿¡</button>
      <button onclick="closeShareModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="tabs" id="tabsContainer"></div>
  <div id="tabContentsContainer"></div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>äºˆå®šã‚’<span id="addModalMode">è¿½åŠ </span></h3>
      <label>æ™‚é–“ï¼š<input type="time" id="timeInput"></label><br>
      <label>ç›®çš„åœ°ï¼š<input type="text" id="descInput"></label><br>
      <label>ãƒ¡ãƒ¢ï¼š<textarea id="noteInput" rows="2"></textarea></label><br>
      <button onclick="saveSchedule()">ä¿å­˜</button>
      <button onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="deleteButton" onclick="deleteSchedule()" style="display:none; color:red;">å‰Šé™¤</button>
    </div>
  </div>

  <!-- åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
  <button class="back-button" onclick="openMapModal()">åœ°å›³ã§è¦‹ã‚‹</button>

  <!-- åœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="mapModal" class="modal">
    <div class="modal-content" style="width: 90%; height: 80%;">
      <h3>äºˆå®šãƒãƒƒãƒ—</h3>
      <div id="map" style="width:100%; height:300px;"></div>
      <button onclick="closeMapModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>



  <button class="back-button" onclick="history.back();">ãŸã³ä¸€è¦§ã«æˆ»ã‚‹</button>

  <!-- Google Maps JavaScript API ã‚’èª­ã¿è¾¼ã‚€ï¼ˆheadã®æœ€å¾Œã«è¿½åŠ ï¼‰-->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU&callback=initMap"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://ebyxjgdbarcxzyerhiqm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVieXhqZ2RiYXJjeHp5ZXJoaXFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTcxMDksImV4cCI6MjA2Nzg5MzEwOX0.LXL7sCS7hEBYUDNZFpiJnDbsmZ7FpKbeNfMd2tLr08w';
    const GOOGLE_MAPS_API_KEY = "AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    let currentTabIndex = 0;
    let editingEntry = null;

    async function geocodePlace(placeName) {
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(placeName)}&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === 'OK') {
        return data.results[0].geometry.location; // { lat, lng }
      } else {
        throw new Error(`å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ${placeName}`);
      }
    }

    async function getTravelTimeInSeconds(origin, destination) {
      const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(destination)}&mode=walking&language=ja&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === "OK") {
        return data.rows[0].elements[0].duration.value; // ç§’
      } else {
        throw new Error("ç§»å‹•æ™‚é–“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    async function checkScheduleFeasibility(schedules) {
      for (let i = 0; i < schedules.length - 1; i++) {
        const a = schedules[i];
        const b = schedules[i + 1];
        if (a.tabIndex !== b.tabIndex) continue;

        try {
          const travelSec = await getTravelTimeInSeconds(a.desc, b.desc);
          const timeA = new Date(`2025-01-01T${a.time}`);
          const timeB = new Date(`2025-01-01T${b.time}`);
          const gapSec = (timeB - timeA) / 1000;

          if (travelSec > gapSec) {
            alert(`ã€Œ${a.desc}ã€ã‹ã‚‰ã€Œ${b.desc}ã€ã¸ã®ç§»å‹•ã«${Math.ceil(travelSec / 60)}åˆ†ã‹ã‹ã‚Šã¾ã™ãŒã€${Math.ceil(gapSec / 60)}åˆ†ã—ã‹ç©ºã„ã¦ã„ã¾ã›ã‚“ï¼`);
          }
        } catch (err) {
          console.warn("ç§»å‹•ãƒã‚§ãƒƒã‚¯å¤±æ•—:", err.message);
        }
      }
    }
    function openMapModal() {
      document.getElementById('mapModal').style.display = 'block';
      initMap(); // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã„ãŸã‚‰åœ°å›³åˆæœŸåŒ–
    }

    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
    }

    async function initMap() {
      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      // ä¸­å¿ƒã¯æœ€åˆã®ç›®çš„åœ°ï¼ˆãªã‘ã‚Œã°æ±äº¬ï¼‰
      let center = { lat: 35.6895, lng: 139.6917 }; // æ±äº¬
      if (schedules.length > 0) {
        try {
          center = await geocodePlace(schedules[0].desc);
        } catch {}
      }

      const map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13
      });
      for (let i = 0; i < schedules.length; i++) {
        const entry = schedules[i];
        try {
          const location = await geocodePlace(entry.desc);
          new google.maps.Marker({
            position: location,
            map,
            label: {
              text: `${i + 1}`,  // â† ç•ªå·ãƒ©ãƒ™ãƒ«
              color: 'white',
              fontWeight: 'bold'
            },
            title: `${entry.time} ${entry.desc}`
          });
        } catch (err) {
          console.warn(`${entry.desc} ã®å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
        }
      }

    }
    function switchTab(index) {
      document.querySelectorAll('.tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
      document.querySelectorAll('.tab-content').forEach((content, i) => content.classList.toggle('active', i === index));
    }

    function openAddModal(index, entry = null) {
      currentTabIndex = index;
      document.getElementById('addModal').style.display = 'block';
      const timeInput = document.getElementById('timeInput');
      const descInput = document.getElementById('descInput');
      const noteInput = document.getElementById('noteInput');
      const modeLabel = document.getElementById('addModalMode');
      const deleteButton = document.getElementById('deleteButton');

      if (entry) {
        editingEntry = entry;
        timeInput.value = entry.getAttribute('data-time');
        descInput.value = entry.querySelector('.entry-label').textContent;
        noteInput.value = entry.querySelector('.entry-label').dataset.note || '';
        modeLabel.textContent = 'ç·¨é›†';
        deleteButton.style.display = 'inline-block'; // è¡¨ç¤º
      } else {
        editingEntry = null;
        timeInput.value = '';
        descInput.value = '';
        noteInput.value = '';
        modeLabel.textContent = 'è¿½åŠ ';
        deleteButton.style.display = 'none'; // éè¡¨ç¤º
      }
    }

  async function deleteSchedule() {
      if (!editingEntry) return;
      if (!confirm("ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

      const id = editingEntry.getAttribute('data-id'); // â† ã“ã“ã§idã‚’å–å¾—

      const { error } = await supabase
        .from("time_schedule")
        .delete()
        .eq("id", id);  // â† idã§å‰Šé™¤ï¼
      console.log("å‰Šé™¤å¯¾è±¡ã®ID:", id);


      if (error) {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(error);
        return;
      }

      editingEntry.remove(); // DOMã‹ã‚‰å‰Šé™¤
      editingEntry = null;
      closeAddModal();
  }


    async function saveSchedule() {
      const time = document.getElementById('timeInput').value;
      const desc = document.getElementById('descInput').value;
      const note = document.getElementById('noteInput').value;
      const params = new URLSearchParams(window.location.search);
      const trip_id = params.get("trip_id"); // URLã‹ã‚‰å–å¾—ï¼ˆä¾‹ï¼š?trip_id=xxxï¼‰

      if (!time || !desc || !trip_id) {
        alert("æ™‚é–“ãƒ»ç›®çš„åœ°ãƒ»trip_id ã¯å¿…é ˆã§ã™");
        return;
      }

      const rawDate = params.get("date"); // ä¾‹: "2025.7.21-22"

      // 1æ—¥ç›®ã€2æ—¥ç›®â€¦ã«å¿œã˜ã¦tabIndexã‹ã‚‰æ—¥ä»˜ã‚’ç”Ÿæˆ
      const match = rawDate.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
      let dayDate = null;
      if (match) {
        const [, year, month, startDay] = match.map(Number);
        const dateObj = new Date(year, month - 1, startDay + currentTabIndex);

        // ğŸ”½ ã“ã“ã‚’ä¿®æ­£ï¼
        const y = dateObj.getFullYear();
        const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const d = dateObj.getDate().toString().padStart(2, '0');
        dayDate = `${y}-${m}-${d}`;
      } else {
        alert("æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™");
        return;
      }

      try {
        const formattedTime = time.length === 5 ? time + ":00" : time;
        let geo = { lat: null, lng: null };
        try {
          geo = await geocodePlace(desc);  // ä½æ‰€ãŒã‚ã‚Œã°å–å¾—
        } catch (e) {
          console.warn("ä½æ‰€ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€ç·¯åº¦çµŒåº¦ã‚’ç©ºã§ä¿å­˜ã—ã¾ã™");
        }

        console.log("ä¿å­˜ã™ã‚‹äºˆå®š:", {
          trip_id,
          date: dayDate,
          time: formattedTime,
          location: desc,
          description: note,
          latitude: geo.lat,
          longitude: geo.lng,
        });
        
        let supabaseResult;
        if (editingEntry) {
          // ç·¨é›†æ™‚ã¯ Supabase ã§ updateï¼ˆtime/location ã‚’å…ƒã«ç‰¹å®šï¼‰
          supabaseResult = await supabase
            .from('time_schedule')
            .update({
              time: formattedTime,
              location: desc,
              description: note,
              latitude: geo.lat,
              longitude: geo.lng,
            })
            .eq("trip_id", trip_id)
            .eq("date", dayDate)
            .eq("time", editingEntry.getAttribute('data-time'))
            .eq("location", editingEntry.querySelector('.entry-label').textContent);
        } else {
          // æ–°è¦è¿½åŠ æ™‚
          supabaseResult = await supabase.from('time_schedule').insert({
            trip_id,
            date: dayDate,
            time: formattedTime,
            location: desc,
            description: note,
            latitude: geo.lat,
            longitude: geo.lng,
          });
        }
        const { error } = supabaseResult;
        
        if (error) {
          console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
          throw error;
        }
        alert("äºˆå®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
        closeAddModal();
        renderSchedule({
          time: formattedTime,
          desc,
          note,
          tabIndex: currentTabIndex,
        });
        location.reload(); // åæ˜ ã®ãŸã‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå¿…è¦ã«å¿œã˜ã¦ renderSchedule ã§ä»£æ›¿å¯èƒ½ï¼‰
      } catch (err) {
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    }

    function closeAddModal() {
      document.getElementById('addModal').style.display = 'none';
    }

    function getSavedKey() {
      const params = new URLSearchParams(window.location.search);
      return `schedules_${params.get("date")}_${params.get("place")}`;
    }

    function renderSchedule(entry) {
      const timelineList = document.querySelectorAll('.tab-content');
      if (!timelineList[entry.tabIndex]) {
        console.warn("æŒ‡å®šã•ã‚ŒãŸ tabIndex ã«å¯¾å¿œã™ã‚‹ .tab-content ãŒå­˜åœ¨ã—ã¾ã›ã‚“", entry);
        return;
      }

      const timeline = timelineList[entry.tabIndex].querySelector('.timeline');
      if (!timeline) {
        console.warn("timeline ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", entry);
        return;
      }

      const newEntry = document.createElement('div');
      newEntry.className = 'timeline-entry';
      newEntry.setAttribute('data-time', entry.time);
      newEntry.setAttribute('data-id', entry.id); 
      newEntry.innerHTML = `${entry.time.slice(0,5)} <span class="entry-label" data-note="${entry.note || ''}" onclick="openAddModal(${entry.tabIndex}, this.parentElement)">${entry.desc}</span>`;
      timeline.appendChild(newEntry);
      sortTimelineEntries(timeline);
    }

    function sortTimelineEntries(timeline) {
      const entries = Array.from(timeline.querySelectorAll('.timeline-entry'));
      entries.sort((a, b) => a.getAttribute('data-time').localeCompare(b.getAttribute('data-time')));
      entries.forEach(e => timeline.appendChild(e));
    }

    function sendShare() {
      const email = document.getElementById('shareEmail').value;
      if (!email) return alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      alert(`${email} ã«ã—ãŠã‚Šã‚’å…±æœ‰ã—ã¾ã—ãŸï¼`);
      closeShareModal();
    }
    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      document.getElementById('shareEmail').value = '';
    }

    document.getElementById('shareButton').addEventListener('click', () => {
      document.getElementById('shareModal').style.display = 'block';
    });

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const date = params.get("date");
      const place = params.get("place");
      const trip_id = params.get("trip_id");
      console.log("trip_id:", trip_id);

      document.querySelector('.trip-title').textContent = `${date} in ${place}`;

      const match = date.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
      if (match) {
        const [, , , start, end] = match.map(Number);
        const dayCount = end - start + 1;
        for (let i = 0; i < dayCount; i++) {
          const tab = document.createElement("div");
          tab.className = "tab" + (i === 0 ? " active" : "");
          tab.textContent = `${i + 1}æ—¥ç›®`;
          tab.onclick = () => switchTab(i);
          tabsContainer.appendChild(tab);

          const content = document.createElement("div");
          content.className = "tab-content" + (i === 0 ? " active" : "");
          content.innerHTML = `<div class="shiori-box">
            <button class="edit-icon-button" data-tab="${i}" onclick="openAddModal(${i})">
              <img src="images/ç·¨é›†ãƒœã‚¿ãƒ³.png" class="edit-icon" alt="ç·¨é›†" width="40" height="40">
            </button>
            <div class="timeline"></div>
          </div>`;
          tabContentsContainer.appendChild(content);
        }
      }

      // â¬‡ï¸ dateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ—…è¡Œé–‹å§‹ãƒ»çµ‚äº†æ—¥ã‚’æŠ½å‡º
      const rawDate = params.get("date"); // ä¾‹: "2025.7.21-23"
      let startDate = null;
      let endDate = null;

      if (match) {
        const [, year, month, startDay, endDay] = match.map(Number);
        const start = new Date(year, month - 1, startDay);
        const end = new Date(year, month - 1, endDay);

        // ä¾‹: date = new Date(2025, 6, 21); // â† æœˆã¯0-indexed
        startDate = new Date(year, month - 1, startDay).toISOString().slice(0, 10);
        endDate = new Date(year, month - 1, endDay).toISOString().slice(0, 10);

      }

      // âœ… Supabaseã‹ã‚‰äºˆå®šå–å¾—ã—ã¦è¡¨ç¤ºï¼ˆâ†ã“ã“ã«ç§»å‹•ã™ã‚‹ï¼ï¼ï¼‰
      const { data: schedules, error: scheduleError } = await supabase
        .from("time_schedule")
        .select("*")
        .eq("trip_id", trip_id)
        .order("date", { ascending: true })


      console.log("æ—…è¡ŒæœŸé–“:", startDate, "ã€œ", endDate);
      console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", schedules);

      if (scheduleError) {
        console.error("äºˆå®šã®å–å¾—ã‚¨ãƒ©ãƒ¼:", scheduleError.message);
        alert("äºˆå®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }

      schedules.forEach(entry => {
        const params = new URLSearchParams(location.search);
        const rawDate = params.get("date"); // ä¾‹: "2025.7.21-23"
        console.log("rawDate:", rawDate);
        const match = rawDate.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);

        let tabIndex = 0;
        if (match) {
          const [, year, month, startDay] = match.map(Number);

          // ğŸ”½ ä¿®æ­£: æ—¥ä»˜ã‚’ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãªã—ã§ãƒ‘ãƒ¼ã‚¹
          const [y, m, d] = entry.date.split("-").map(Number);
          const entryDate = new Date(y, m - 1, d);
          const baseDate = new Date(year, month - 1, startDay);
          
          tabIndex = Math.floor((entryDate - baseDate) / (1000 * 60 * 60 * 24));

          if (tabIndex < 0) return; // ç¯„å›²å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—
        }
        entry.tabIndex = tabIndex;
        entry.desc = entry.location;
        entry.note = entry.description;
        renderSchedule(entry);
      });



      checkScheduleFeasibility(schedules);
    });


  </script>
</body>
</html>
