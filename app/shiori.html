<!-- 修正後の完全なコード -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>しおり詳細</title>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">

  <!-- OGP（LINEやTwitterにリンク貼るときのカード情報） -->
  <meta property="og:title" content="たびNaVi">
  <meta property="og:description" content="しおりを作って旅をもっと楽しく！">
  <meta property="og:image" content="https://staging.d3mfjfwilpc96w.amplifyapp.com/logo.png">
  <meta property="og:url" content="https://staging.d3mfjfwilpc96w.amplifyapp.com">
  <meta property="og:type" content="website">
  
  <!-- ファビコン -->
  <link rel="icon" href="logo.png" type="image/png">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon-precomposed" href="logo.png">
  <link rel="shortcut icon" href="logo.png" type="image/png">
  
  <style>
    body {
      font-family: 'Zen Maru Gothic', 'Kiwi Maru', sans-serif;
      margin: 0;
      padding: 10px;
      max-width: 480px;
      margin: auto;
      background-color: #fff;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      height: 100px;
    }
    .trip-title {
      font-size: 25px;
      padding: 10px 3px;
      border-bottom: 2px solid #333;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 5px;
    }
    .tab {
      padding: 5px 10px;
      border: 2px solid #000;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background-color: #dcdcdc;
      font-weight: bold;
      cursor: pointer;
    }
    .tab.active { background-color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .shiori-box {
      position: relative;
      background-color: #ffffff;
      border: 2px solid #000;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
      min-height: 400px;

      /* 背景の画像は透明ボックスで扱う */
      overflow: hidden;
    }

    .shiori-box::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('corgi_placeholder.png'); /* 正しいファイル名にする */
      background-repeat: no-repeat;
      background-position: center bottom;
      background-size: contain;
      filter: opacity(0.2); /* ← 背景画像だけを薄く！ */
      z-index: 0;
      pointer-events: none;
    }

    .shiori-box > * {
      position: relative;
      z-index: 1; /* 文字やアイコンを前面に出す */
    }


    .edit-icon-button {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 0;
      background: #c5c3bf;
      cursor: pointer;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      z-index: 10;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timeline {
      margin-left: 20px;
      border-left: 2px solid black;
      padding-left: 15px;
    }
    .timeline-entry {
      position: relative;
      margin-bottom: 20px;
    }
    .timeline-entry::before {
      content: '';
      position: absolute;
      left: -21px;
      top: 3px;
      width: 10px;
      height: 10px;
      background-color: #003344;
      border-radius: 50%;
    }
    .entry-label {
      color: #003344;
      text-decoration: underline;
      cursor: pointer;
    }
    .back-button {
      display: block;
      margin: 0 auto;
      background-color: white;
      border: 2px solid black;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 50;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      max-width: 80%;
      margin: 15% auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .share_button {
      border: 2px solid #0f1618;
      border-radius: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }
    #addModal textarea {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo_たびなび.png" class="logo" alt="ロゴ">
    <div class="trip-title"></div>
    <img src="share_logo.png" class="share_button" id="shareButton" alt="共有">
  </div>

  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>しおりを共有</h3>
      <label>メールアドレス：</label><br>
      <input type="email" id="shareEmail" placeholder="example@example.com"><br><br>
      <button onclick="sendShare()">送信</button>
      <button onclick="closeShareModal()">キャンセル</button>
    </div>
  </div>

  <div class="tabs" id="tabsContainer"></div>
  <div id="tabContentsContainer"></div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>予定を<span id="addModalMode">追加</span></h3>
      <label>時間：<input type="time" id="timeInput"></label><br>
      <label>目的地：<input type="text" id="descInput"></label><br>
      <label>メモ：<textarea id="noteInput" rows="2"></textarea></label><br>
      <button onclick="saveSchedule()">保存</button>
      <button onclick="closeAddModal()">キャンセル</button>
      <button id="deleteButton" onclick="deleteSchedule()" style="display:none; color:red;">削除</button>
    </div>
  </div>

  <!-- 地図表示ボタン -->
  <button class="back-button" onclick="openMapModal()">地図で見る</button>

  <!-- 地図モーダル -->
  <div id="mapModal" class="modal">
    <div class="modal-content" style="width: 90%; height: 80%;">
      <h3>予定マップ</h3>
      <div id="map" style="width:100%; height:300px;"></div>
      <button onclick="closeMapModal()">閉じる</button>
    </div>
  </div>



  <button class="back-button" onclick="history.back();">たび一覧に戻る</button>

  <!-- Google Maps JavaScript API を読み込む（headの最後に追加）-->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU&callback=initMap"></script>
  <script>
    const GOOGLE_MAPS_API_KEY = "AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU"; // ← あなたのキーに置換

    let currentTabIndex = 0;
    let editingEntry = null;

    async function geocodePlace(placeName) {
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(placeName)}&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === 'OK') {
        return data.results[0].geometry.location; // { lat, lng }
      } else {
        throw new Error(`場所が見つかりませんでした: ${placeName}`);
      }
    }

    async function getTravelTimeInSeconds(origin, destination) {
      const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(destination)}&mode=walking&language=ja&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === "OK") {
        return data.rows[0].elements[0].duration.value; // 秒
      } else {
        throw new Error("移動時間の取得に失敗しました");
      }
    }

    async function checkScheduleFeasibility(schedules) {
      for (let i = 0; i < schedules.length - 1; i++) {
        const a = schedules[i];
        const b = schedules[i + 1];
        if (a.tabIndex !== b.tabIndex) continue;

        try {
          const travelSec = await getTravelTimeInSeconds(a.desc, b.desc);
          const timeA = new Date(`2025-01-01T${a.time}`);
          const timeB = new Date(`2025-01-01T${b.time}`);
          const gapSec = (timeB - timeA) / 1000;

          if (travelSec > gapSec) {
            alert(`「${a.desc}」から「${b.desc}」への移動に${Math.ceil(travelSec / 60)}分かかりますが、${Math.ceil(gapSec / 60)}分しか空いていません！`);
          }
        } catch (err) {
          console.warn("移動チェック失敗:", err.message);
        }
      }
    }
    function openMapModal() {
      document.getElementById('mapModal').style.display = 'block';
      initMap(); // モーダル開いたら地図初期化
    }

    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
    }

    async function initMap() {
      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      // 中心は最初の目的地（なければ東京）
      let center = { lat: 35.6895, lng: 139.6917 }; // 東京
      if (schedules.length > 0) {
        try {
          center = await geocodePlace(schedules[0].desc);
        } catch {}
      }

      const map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13
      });
      for (let i = 0; i < schedules.length; i++) {
        const entry = schedules[i];
        try {
          const location = await geocodePlace(entry.desc);
          new google.maps.Marker({
            position: location,
            map,
            label: {
              text: `${i + 1}`,  // ← 番号ラベル
              color: 'white',
              fontWeight: 'bold'
            },
            title: `${entry.time} ${entry.desc}`
          });
        } catch (err) {
          console.warn(`${entry.desc} の場所が見つかりませんでした`);
        }
      }

    }
    function switchTab(index) {
      document.querySelectorAll('.tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
      document.querySelectorAll('.tab-content').forEach((content, i) => content.classList.toggle('active', i === index));
    }

    function openAddModal(index, entry = null) {
      currentTabIndex = index;
      document.getElementById('addModal').style.display = 'block';
      const timeInput = document.getElementById('timeInput');
      const descInput = document.getElementById('descInput');
      const noteInput = document.getElementById('noteInput');
      const modeLabel = document.getElementById('addModalMode');
      const deleteButton = document.getElementById('deleteButton');

      if (entry) {
        editingEntry = entry;
        timeInput.value = entry.getAttribute('data-time');
        descInput.value = entry.querySelector('.entry-label').textContent;
        noteInput.value = entry.querySelector('.entry-label').dataset.note || '';
        modeLabel.textContent = '編集';
        deleteButton.style.display = 'inline-block'; // 表示
      } else {
        editingEntry = null;
        timeInput.value = '';
        descInput.value = '';
        noteInput.value = '';
        modeLabel.textContent = '追加';
        deleteButton.style.display = 'none'; // 非表示
      }
    }

    function deleteSchedule() {
      if (!editingEntry) return;

      if (!confirm("この予定を削除しますか？")) return;

      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      const time = editingEntry.getAttribute('data-time');
      const desc = editingEntry.querySelector('.entry-label').textContent;

      const updated = schedules.filter(entry => !(entry.time === time && entry.desc === desc && entry.tabIndex === currentTabIndex));
      localStorage.setItem(savedKey, JSON.stringify(updated));

      editingEntry.remove(); // DOMから削除
      editingEntry = null;
      closeAddModal();
    }

    function saveSchedule() {
      const time = document.getElementById('timeInput').value;
      const desc = document.getElementById('descInput').value;
      const note = document.getElementById('noteInput').value;
      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      if (!time || !desc) {
        alert("時間と目的地を入力してください");
        return;
      }

      if (editingEntry) {
        const oldTime = editingEntry.getAttribute('data-time');
        const oldDesc = editingEntry.querySelector('.entry-label').textContent;
        for (let entry of schedules) {
          if (entry.time === oldTime && entry.desc === oldDesc && entry.tabIndex === currentTabIndex) {
            entry.time = time;
            entry.desc = desc;
            entry.note = note;
            break;
          }
        }
        localStorage.setItem(savedKey, JSON.stringify(schedules));
        editingEntry.setAttribute('data-time', time);
        editingEntry.innerHTML = `${time} <span class="entry-label" data-note="${note}" onclick="openAddModal(${currentTabIndex}, this.parentElement)">${desc}</span>`;
        editingEntry = null;
      } else {
        const newEntry = { time, desc, note, tabIndex: currentTabIndex };
        schedules.push(newEntry);
        localStorage.setItem(savedKey, JSON.stringify(schedules));
        renderSchedule(newEntry);
      }

      closeAddModal();
    }

    function closeAddModal() {
      document.getElementById('addModal').style.display = 'none';
    }

    function getSavedKey() {
      const params = new URLSearchParams(window.location.search);
      return `schedules_${params.get("date")}_${params.get("place")}`;
    }

    function renderSchedule(entry) {
      const timeline = document.querySelectorAll('.tab-content')[entry.tabIndex].querySelector('.timeline');
      const newEntry = document.createElement('div');
      newEntry.className = 'timeline-entry';
      newEntry.setAttribute('data-time', entry.time);
      newEntry.innerHTML = `${entry.time} <span class="entry-label" data-note="${entry.note || ''}" onclick="openAddModal(${entry.tabIndex}, this.parentElement)">${entry.desc}</span>`;
      timeline.appendChild(newEntry);
      sortTimelineEntries(timeline);
    }

    function sortTimelineEntries(timeline) {
      const entries = Array.from(timeline.querySelectorAll('.timeline-entry'));
      entries.sort((a, b) => a.getAttribute('data-time').localeCompare(b.getAttribute('data-time')));
      entries.forEach(e => timeline.appendChild(e));
    }

    function sendShare() {
      const email = document.getElementById('shareEmail').value;
      if (!email) return alert("メールアドレスを入力してください");
      alert(`${email} にしおりを共有しました！`);
      closeShareModal();
    }
    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      document.getElementById('shareEmail').value = '';
    }

    document.getElementById('shareButton').addEventListener('click', () => {
      document.getElementById('shareModal').style.display = 'block';
    });

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(location.search);
      const date = params.get("date");
      const place = params.get("place");
      document.querySelector('.trip-title').textContent = `${date} in ${place}`;

      const match = date.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
      if (match) {
        const [, , , start, end] = match.map(Number);
        const dayCount = end - start + 1;
        for (let i = 0; i < dayCount; i++) {
          const tab = document.createElement("div");
          tab.className = "tab" + (i === 0 ? " active" : "");
          tab.textContent = `${i + 1}日目`;
          tab.onclick = () => switchTab(i);
          tabsContainer.appendChild(tab);

          const content = document.createElement("div");
          content.className = "tab-content" + (i === 0 ? " active" : "");
          content.innerHTML = `<div class="shiori-box">
            <button class="edit-icon-button" data-tab="${i}" onclick="openAddModal(${i})">
              <img src="編集ボタン.png" class="edit-icon" alt="編集" width="40" height="40">
            </button>
            <div class="timeline"></div>
          </div>`;
          tabContentsContainer.appendChild(content);
        }
      }

      const schedules = JSON.parse(localStorage.getItem(getSavedKey()) || "[]");
      schedules.forEach(renderSchedule);
      checkScheduleFeasibility(schedules); // ← ここ追加！

    });
  </script>
</body>
</html>
