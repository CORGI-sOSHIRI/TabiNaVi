<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>しおり詳細</title>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      max-width: 480px;
      margin: auto;
      background-color: #fff;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      height: 100px;
    }

    .trip-title {
      font-family: 'Zen Maru Gothic', 'Kiwi Maru', sans-serif;
      font-size: 25px;
      padding: 10px 3px;

      border: none;
      border-bottom: 2px solid #333;  /* 下線を追加 */
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 5px;
    }

    .tab {
      padding: 5px 10px;
      border: 2px solid #000;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background-color: #dcdcdc;
      font-weight: bold;
      cursor: pointer;
    }

    .tab.active {
      background-color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .shiori-box {
      background-color: #f0f0f0;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
      position: relative;
      min-height: 400px;
      border: none;
    }

    .tab-content.active .shiori-box {
      background-color: #ffffff;
      border: 2px solid #000000;
    }

    .edit-icon-button {
      position: absolute;
      top: 5px;
      right: 10px;
      padding: 0;
      background: #c5c3bf;
      cursor: pointer;
      border-radius: 10px;  /* ← 丸くする！ */
      width: 40px;
      height: 40px;
      z-index: 10;
    }


    .timeline {
      position: relative;
      margin-left: 20px;
      border-left: 2px solid black;
      padding-left: 15px;
    }

    .timeline-entry {
      position: relative;
      margin-bottom: 20px;
    }

    .timeline-entry::before {
      content: '';
      position: absolute;
      left: -21px;
      top: 3px;
      width: 10px;
      height: 10px;
      background-color: #003344;
      border-radius: 10px;
    }

    .entry-label {
      color: #003344;
      text-decoration: underline;
      cursor: pointer;
    }

    .back-button {
      display: block;
      margin: 0 auto;
      background-color: white;
      border: 2px solid black;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 50;
    }

    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      max-width: 80%;
      margin: 15% auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .share_button{
      border: 2px solid #0f1618;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      right: 10px;
      top: 10px;
    }


    #memoModal {
      display: none;
      position: fixed;
      top: 30%;
      left: 10%;
      width: 80%;
      background: #fff;
      border: 2px solid #003344;
      border-radius: 10px;
      padding: 15px;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #memoModal textarea {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      margin-bottom: 10px;
    }

    #memoModal button {
      margin-right: 60px;
    }

    #addModal {
      width: 100%;
      max-width: 480px;  /* ← .shiori-box と同じに！ */
    }


  </style>
</head>
<body>
  <div class="header">
    <img src="logo_たびなび.png" class="logo" alt="ロゴ">
    <div class="trip-title"></div>
    <img src="share_logo.png" class="share_button" id="shareButton" alt="共有" >
  </div>

  <!-- ▼ 共有モーダル -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>しおりを共有</h3>
      <label>メールアドレス：</label><br>
      <input type="email" id="shareEmail" placeholder="example@example.com" required><br><br>
      <button onclick="sendShare()">送信</button>
      <button onclick="closeShareModal()">キャンセル</button>
    </div>
  </div>

  <div class="tabs" id="tabsContainer"></div>
  <div id="tabContentsContainer"></div>

  <!-- ▼ メモ入力モーダル -->
  <div id="memoModal">
    <h3>メモを編集</h3>
    <textarea id="memoTextarea" rows="4" placeholder="メモを書いてね！"></textarea><br>
    <button onclick="saveMemo()">保存</button>
    <button onclick="closeMemo()">キャンセル</button>
  </div>

  <!-- ▼ 予定追加モーダル -->
  <div id="addModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>予定を<span id="addModalMode">追加</span></h3>
      <label>時間：<input type="time" id="timeInput"></label><br>
      <label>目的地：<input type="text" id="descInput" placeholder="例：カフェ"></label><br>
      <button onclick="saveSchedule()">保存</button>
      <button onclick="closeAddModal()">キャンセル</button>
    </div>
  </div>


  <button class="back-button" onclick="history.back();">たび一覧に戻る</button>

  <script>
    let currentLabel = null;
    let currentTabIndex = 0;
    let editingEntry = null; // 編集対象

    function switchTab(index) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach((tab, i) => tab.classList.toggle('active', i === index));
      contents.forEach((content, i) => content.classList.toggle('active', i === index));
    }

    function handleClick(labelSpan) {
      currentLabel = labelSpan;
      document.getElementById('memoTextarea').value = labelSpan.dataset.note || '';
      document.getElementById('memoModal').style.display = 'block';
    }

    function saveMemo() {
      const note = document.getElementById('memoTextarea').value;
      currentLabel.dataset.note = note;
      closeMemo();
    }

    function closeMemo() {
      document.getElementById('memoModal').style.display = 'none';
    }

    function openAddModal(index, entry = null) {
      currentTabIndex = index;
      document.getElementById('addModal').style.display = 'block';
      const timeInput = document.getElementById('timeInput');
      const descInput = document.getElementById('descInput');
      const modeLabel = document.getElementById('addModalMode');

      if (entry) {
        editingEntry = entry;
        timeInput.value = entry.getAttribute('data-time');
        descInput.value = entry.querySelector('.entry-label').textContent;
        modeLabel.textContent = '編集';
      } else {
        editingEntry = null;
        timeInput.value = '';
        descInput.value = '';
        modeLabel.textContent = '追加';
      }
    }

    function saveSchedule() {
      const time = document.getElementById('timeInput').value;
      const desc = document.getElementById('descInput').value;
      if (!time || !desc) {
        alert("時間と内容を入力してください");
        return;
      }

      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      if (editingEntry) {
        // localStorageから更新対象を探す
        const oldTime = editingEntry.getAttribute('data-time');
        const oldDesc = editingEntry.querySelector('.entry-label').textContent;
        for (let entry of schedules) {
          if (entry.time === oldTime && entry.desc === oldDesc && entry.tabIndex === currentTabIndex) {
            entry.time = time;
            entry.desc = desc;
            break;
          }
        }
        localStorage.setItem(savedKey, JSON.stringify(schedules));

        // DOM更新
        editingEntry.setAttribute('data-time', time);
        editingEntry.innerHTML = `${time} <span class="entry-label" onclick="handleClick(this)" data-note="">${desc}</span>
          <button onclick="editSchedule(this)">編集</button>`;
        editingEntry = null;
      } else {
        const entry = { time, desc, note: '', tabIndex: currentTabIndex };
        schedules.push(entry);
        localStorage.setItem(savedKey, JSON.stringify(schedules));
        renderSchedule(entry);
      }

      closeAddModal();
    }

    function closeAddModal() {
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('timeInput').value = '';
      document.getElementById('descInput').value = '';
    }

    function addSchedule() {
      const time = document.getElementById('timeInput').value;
      const desc = document.getElementById('descInput').value;
      if (!time || !desc) {
        alert("時間と内容を入力してください");
        return;
      }

      const entry = {
        time,
        desc,
        note: '',
        tabIndex: currentTabIndex
      };

      // 保存
      const savedKey = getSavedKey();  // 日付+場所に基づいたキー
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");
      schedules.push(entry);
      localStorage.setItem(savedKey, JSON.stringify(schedules));

      // 表示
      renderSchedule(entry);

      closeAddModal();
    }

    function sortTimelineEntries(timeline) {
      const entries = Array.from(timeline.querySelectorAll('.timeline-entry'));
      entries.sort((a, b) => {
        const timeA = a.getAttribute('data-time') || a.textContent.trim().slice(0, 5);
        const timeB = b.getAttribute('data-time') || b.textContent.trim().slice(0, 5);
        return timeA.localeCompare(timeB);
      });
      entries.forEach(entry => timeline.appendChild(entry));
    }

    document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);
      const date = params.get("date");
      const place = params.get("place");

      if (date && place) {
        document.querySelector('.trip-title').textContent = `${date} in ${place}`;

        // 例: "2025.9.3-7" を取得
        const match = date.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
        if (match) {
          const [, year, month, start, end] = match.map(Number);
          const dayCount = end - start + 1;
          const tabsContainer = document.getElementById("tabsContainer");
          const tabContents = document.getElementById("tabContentsContainer");

          for (let i = 0; i < dayCount; i++) {
            // タブ作成
            const tab = document.createElement("div");
            tab.className = "tab" + (i === 0 ? " active" : "");
            tab.textContent = `${i + 1}日目`;
            tab.onclick = () => switchTab(i);
            tabsContainer.appendChild(tab);

            // コンテンツ作成
            const content = document.createElement("div");
            content.className = "tab-content" + (i === 0 ? " active" : "");
            content.innerHTML = `
              <div class="shiori-box">
                <button class="edit-icon-button" data-type="add" data-tab="${i}" aria-label="予定追加">
                  <img src="編集ボタン.png" class="edit-icon" alt="編集" width="40" height="40">
                </button>
                <div class="timeline"></div>
              </div>
            `;
            tabContents.appendChild(content);
          }

          // 編集ボタンのイベントを再設定
          document.querySelectorAll('.edit-icon-button').forEach(button => {
            button.addEventListener('click', () => {
              const type = button.dataset.type;
              const tabIndex = parseInt(button.dataset.tab);
              if (type === 'add') {
                openAddModal(tabIndex);
              }
            });
          });
        }
      }

      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");
      schedules.forEach(renderSchedule);

      // 共有ボタン

    });

    document.getElementById('shareButton').addEventListener('click', function () {
      document.getElementById('shareModal').style.display = 'block';
    });

    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      document.getElementById('shareEmail').value = '';
    }

    function sendShare() {
      const email = document.getElementById('shareEmail').value;
      if (!email) {
        alert("メールアドレスを入力してください");
        return;
      }
      alert(`${email} にしおりを共有しました！`);
      closeShareModal();
    }

    function getSavedKey() {
      const params = new URLSearchParams(window.location.search);
      const date = params.get("date");
      const place = params.get("place");
      return `schedules_${date}_${place}`;
    }
    
    function saveMemo() {
      const note = document.getElementById('memoTextarea').value;
      currentLabel.dataset.note = note;

      // 保存先を更新
      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      // 時間と内容が一致するものを更新
      const parent = currentLabel.closest('.timeline-entry');
      const time = parent.getAttribute('data-time');
      const desc = currentLabel.textContent;

      for (let entry of schedules) {
        if (entry.time === time && entry.desc === desc) {
          entry.note = note;
          break;
        }
      }
      localStorage.setItem(savedKey, JSON.stringify(schedules));

      closeMemo();
    }

    function renderSchedule(entry) {
      const tabContents = document.querySelectorAll('.tab-content');
      const targetTimeline = tabContents[entry.tabIndex].querySelector('.timeline');

      const newEntry = document.createElement('div');
      newEntry.className = 'timeline-entry';
      newEntry.setAttribute('data-time', entry.time);
      newEntry.innerHTML = `${entry.time} <span class="entry-label" onclick="handleClick(this)" data-note="${entry.note || ''}">${entry.desc}</span>
        <button onclick="editSchedule(this)">編集</button>`;

      targetTimeline.appendChild(newEntry);
      sortTimelineEntries(targetTimeline);
    }

    function editSchedule(button) {
      const entry = button.closest('.timeline-entry');
      const tab = entry.closest('.tab-content');
      const tabIndex = Array.from(document.querySelectorAll('.tab-content')).indexOf(tab);
      openAddModal(tabIndex, entry);
    }
  </script>
</body>
</html>

