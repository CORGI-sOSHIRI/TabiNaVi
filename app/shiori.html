<!-- 修正後の完全なコード -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>しおり詳細</title>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">

  <!-- OGP（LINEやTwitterにリンク貼るときのカード情報） -->
  <meta property="og:title" content="たびNaVi">
  <meta property="og:description" content="しおりを作って旅をもっと楽しく！">
  <meta property="og:image" content="https://staging.d3mfjfwilpc96w.amplifyapp.com/logo.png">
  <meta property="og:url" content="https://staging.d3mfjfwilpc96w.amplifyapp.com">
  <meta property="og:type" content="website">
  
  <!-- ファビコン -->
  <link rel="icon" href="logo_たびなび.png" type="image/png">
  <link rel="apple-touch-icon" href="logo_たびなび.png">
  <link rel="apple-touch-icon-precomposed" href="logo_たびなび.png">
  <link rel="shortcut icon" href="logo_たびなび.png" type="image/png">
  
  <style>
    body {
      font-family: 'Zen Maru Gothic', 'Kiwi Maru', sans-serif;
      margin: 0;
      padding: 10px;
      max-width: 480px;
      margin: auto;
      background-color: #fff;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      height: 100px;
    }
    .trip-title {
      font-size: 25px;
      padding: 10px 3px;
      border-bottom: 2px solid #333;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 5px;
    }
    .tab {
      padding: 5px 10px;
      border: 2px solid #000;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background-color: #dcdcdc;
      font-weight: bold;
      cursor: pointer;
    }
    .tab.active { background-color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .shiori-box {
      position: relative;
      background-color: #ffffff;
      border: 2px solid #000;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 20px;
      min-height: 400px;

      /* 背景の画像は透明ボックスで扱う */
      overflow: hidden;
    }

    .shiori-box::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url('images/corgi_placeholder.png'); /* 正しいファイル名にする */
      background-repeat: no-repeat;
      background-position: center bottom;
      background-size: contain;
      filter: opacity(0.2); /* ← 背景画像だけを薄く！ */
      z-index: 0;
      pointer-events: none;
    }

    .shiori-box > * {
      position: relative;
      z-index: 1; /* 文字やアイコンを前面に出す */
    }


    .edit-icon-button {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 0;
      background: #c5c3bf;
      cursor: pointer;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      z-index: 10;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timeline {
      margin-left: 20px;
      border-left: 2px solid black;
      padding-left: 15px;
    }
    .timeline-entry {
      position: relative;
      margin-bottom: 20px;
    }
    .timeline-entry::before {
      content: '';
      position: absolute;
      left: -21px;
      top: 3px;
      width: 10px;
      height: 10px;
      background-color: #003344;
      border-radius: 50%;
    }
    .entry-label {
      color: #003344;
      text-decoration: underline;
      cursor: pointer;
    }
    .back-button {
      display: block;
      margin: 0 auto;
      background-color: white;
      border: 2px solid black;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 50;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      max-width: 80%;
      margin: 15% auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .share_button {
      border: 2px solid #0f1618;
      border-radius: 10px;
      top: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }
    #addModal textarea {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo_たびなび.png" class="logo" alt="ロゴ">
    <div class="trip-title"></div>
    <img src="images/share_logo.png" class="share_button" id="shareButton" alt="共有">
  </div>

  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>しおりを共有</h3>
      <label>メールアドレス：</label><br>
      <input type="email" id="shareEmail" placeholder="example@example.com"><br><br>
      <button onclick="sendShare()">送信</button>
      <button onclick="closeShareModal()">キャンセル</button>
    </div>
  </div>

  <div class="tabs" id="tabsContainer"></div>
  <div id="tabContentsContainer"></div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>予定を<span id="addModalMode">追加</span></h3>
      <label>時間：<input type="time" id="timeInput"></label><br>
      <label>目的地：<input type="text" id="descInput"></label><br>
      <label>メモ：<textarea id="noteInput" rows="2"></textarea></label><br>
      <button onclick="saveSchedule()">保存</button>
      <button onclick="closeAddModal()">キャンセル</button>
      <button id="deleteButton" onclick="deleteSchedule()" style="display:none; color:red;">削除</button>
    </div>
  </div>

  <!-- 地図表示ボタン -->
  <button class="back-button" onclick="openMapModal()">地図で見る</button>

  <!-- 地図モーダル -->
  <div id="mapModal" class="modal">
    <div class="modal-content" style="width: 90%; height: 80%;">
      <h3>予定マップ</h3>
      <div id="map" style="width:100%; height:300px;"></div>
      <button onclick="closeMapModal()">閉じる</button>
    </div>
  </div>



  <button class="back-button" onclick="history.back();">たび一覧に戻る</button>

  <!-- Google Maps JavaScript API を読み込む（headの最後に追加）-->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU&callback=initMap"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://ebyxjgdbarcxzyerhiqm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVieXhqZ2RiYXJjeHp5ZXJoaXFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTcxMDksImV4cCI6MjA2Nzg5MzEwOX0.LXL7sCS7hEBYUDNZFpiJnDbsmZ7FpKbeNfMd2tLr08w';
    const GOOGLE_MAPS_API_KEY = "AIzaSyBvPeUOz2JUCE9eZOK-S5bPY4rGTY6cvXU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    let currentTabIndex = 0;
    let editingEntry = null;

    async function geocodePlace(placeName) {
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(placeName)}&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === 'OK') {
        return data.results[0].geometry.location; // { lat, lng }
      } else {
        throw new Error(`場所が見つかりませんでした: ${placeName}`);
      }
    }

    async function getTravelTimeInSeconds(origin, destination) {
      const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(destination)}&mode=walking&language=ja&key=${GOOGLE_MAPS_API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === "OK") {
        return data.rows[0].elements[0].duration.value; // 秒
      } else {
        throw new Error("移動時間の取得に失敗しました");
      }
    }

    async function checkScheduleFeasibility(schedules) {
      for (let i = 0; i < schedules.length - 1; i++) {
        const a = schedules[i];
        const b = schedules[i + 1];
        if (a.tabIndex !== b.tabIndex) continue;

        try {
          const travelSec = await getTravelTimeInSeconds(a.desc, b.desc);
          const timeA = new Date(`2025-01-01T${a.time}`);
          const timeB = new Date(`2025-01-01T${b.time}`);
          const gapSec = (timeB - timeA) / 1000;

          if (travelSec > gapSec) {
            alert(`「${a.desc}」から「${b.desc}」への移動に${Math.ceil(travelSec / 60)}分かかりますが、${Math.ceil(gapSec / 60)}分しか空いていません！`);
          }
        } catch (err) {
          console.warn("移動チェック失敗:", err.message);
        }
      }
    }
    function openMapModal() {
      document.getElementById('mapModal').style.display = 'block';
      initMap(); // モーダル開いたら地図初期化
    }

    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
    }

    async function initMap() {
      const savedKey = getSavedKey();
      const schedules = JSON.parse(localStorage.getItem(savedKey) || "[]");

      // 中心は最初の目的地（なければ東京）
      let center = { lat: 35.6895, lng: 139.6917 }; // 東京
      if (schedules.length > 0) {
        try {
          center = await geocodePlace(schedules[0].desc);
        } catch {}
      }

      const map = new google.maps.Map(document.getElementById('map'), {
        center,
        zoom: 13
      });
      for (let i = 0; i < schedules.length; i++) {
        const entry = schedules[i];
        try {
          const location = await geocodePlace(entry.desc);
          new google.maps.Marker({
            position: location,
            map,
            label: {
              text: `${i + 1}`,  // ← 番号ラベル
              color: 'white',
              fontWeight: 'bold'
            },
            title: `${entry.time} ${entry.desc}`
          });
        } catch (err) {
          console.warn(`${entry.desc} の場所が見つかりませんでした`);
        }
      }

    }
    function switchTab(index) {
      document.querySelectorAll('.tab').forEach((tab, i) => tab.classList.toggle('active', i === index));
      document.querySelectorAll('.tab-content').forEach((content, i) => content.classList.toggle('active', i === index));
    }

    function openAddModal(index, entry = null) {
      currentTabIndex = index;
      document.getElementById('addModal').style.display = 'block';
      const timeInput = document.getElementById('timeInput');
      const descInput = document.getElementById('descInput');
      const noteInput = document.getElementById('noteInput');
      const modeLabel = document.getElementById('addModalMode');
      const deleteButton = document.getElementById('deleteButton');

      if (entry) {
        editingEntry = entry;
        timeInput.value = entry.getAttribute('data-time');
        descInput.value = entry.querySelector('.entry-label').textContent;
        noteInput.value = entry.querySelector('.entry-label').dataset.note || '';
        modeLabel.textContent = '編集';
        deleteButton.style.display = 'inline-block'; // 表示
      } else {
        editingEntry = null;
        timeInput.value = '';
        descInput.value = '';
        noteInput.value = '';
        modeLabel.textContent = '追加';
        deleteButton.style.display = 'none'; // 非表示
      }
    }

  async function deleteSchedule() {
      if (!editingEntry) return;
      if (!confirm("この予定を削除しますか？")) return;

      const id = editingEntry.getAttribute('data-id'); // ← ここでidを取得

      const { error } = await supabase
        .from("time_schedule")
        .delete()
        .eq("id", id);  // ← idで削除！
      console.log("削除対象のID:", id);


      if (error) {
        alert("削除に失敗しました");
        console.error(error);
        return;
      }

      editingEntry.remove(); // DOMから削除
      editingEntry = null;
      closeAddModal();
  }


    async function saveSchedule() {
      const time = document.getElementById('timeInput').value;
      const desc = document.getElementById('descInput').value;
      const note = document.getElementById('noteInput').value;
      const params = new URLSearchParams(window.location.search);
      const trip_id = params.get("trip_id"); // URLから取得（例：?trip_id=xxx）

      if (!time || !desc || !trip_id) {
        alert("時間・目的地・trip_id は必須です");
        return;
      }

      const rawDate = params.get("date"); // 例: "2025.7.21-22"

      // 1日目、2日目…に応じてtabIndexから日付を生成
      const match = rawDate.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
      let dayDate = null;
      if (match) {
        const [, year, month, startDay] = match.map(Number);
        const dateObj = new Date(year, month - 1, startDay + currentTabIndex);

        // 🔽 ここを修正！
        const y = dateObj.getFullYear();
        const m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const d = dateObj.getDate().toString().padStart(2, '0');
        dayDate = `${y}-${m}-${d}`;
      } else {
        alert("日付フォーマットが不正です");
        return;
      }

      try {
        const formattedTime = time.length === 5 ? time + ":00" : time;
        let geo = { lat: null, lng: null };
        try {
          geo = await geocodePlace(desc);  // 住所があれば取得
        } catch (e) {
          console.warn("住所が見つからなかったため、緯度経度を空で保存します");
        }

        console.log("保存する予定:", {
          trip_id,
          date: dayDate,
          time: formattedTime,
          location: desc,
          description: note,
          latitude: geo.lat,
          longitude: geo.lng,
        });
        
        let supabaseResult;
        if (editingEntry) {
          // 編集時は Supabase で update（time/location を元に特定）
          supabaseResult = await supabase
            .from('time_schedule')
            .update({
              time: formattedTime,
              location: desc,
              description: note,
              latitude: geo.lat,
              longitude: geo.lng,
            })
            .eq("trip_id", trip_id)
            .eq("date", dayDate)
            .eq("time", editingEntry.getAttribute('data-time'))
            .eq("location", editingEntry.querySelector('.entry-label').textContent);
        } else {
          // 新規追加時
          supabaseResult = await supabase.from('time_schedule').insert({
            trip_id,
            date: dayDate,
            time: formattedTime,
            location: desc,
            description: note,
            latitude: geo.lat,
            longitude: geo.lng,
          });
        }
        const { error } = supabaseResult;
        
        if (error) {
          console.error("保存エラー:", error);
          throw error;
        }
        alert("予定が保存されました！");
        closeAddModal();
        renderSchedule({
          time: formattedTime,
          desc,
          note,
          tabIndex: currentTabIndex,
        });
        location.reload(); // 反映のためにリロード（必要に応じて renderSchedule で代替可能）
      } catch (err) {
        alert("保存に失敗しました: " + err.message);
      }
    }

    function closeAddModal() {
      document.getElementById('addModal').style.display = 'none';
    }

    function getSavedKey() {
      const params = new URLSearchParams(window.location.search);
      return `schedules_${params.get("date")}_${params.get("place")}`;
    }

    function renderSchedule(entry) {
      const timelineList = document.querySelectorAll('.tab-content');
      if (!timelineList[entry.tabIndex]) {
        console.warn("指定された tabIndex に対応する .tab-content が存在しません", entry);
        return;
      }

      const timeline = timelineList[entry.tabIndex].querySelector('.timeline');
      if (!timeline) {
        console.warn("timeline が見つかりません", entry);
        return;
      }

      const newEntry = document.createElement('div');
      newEntry.className = 'timeline-entry';
      newEntry.setAttribute('data-time', entry.time);
      newEntry.setAttribute('data-id', entry.id); 
      newEntry.innerHTML = `${entry.time.slice(0,5)} <span class="entry-label" data-note="${entry.note || ''}" onclick="openAddModal(${entry.tabIndex}, this.parentElement)">${entry.desc}</span>`;
      timeline.appendChild(newEntry);
      sortTimelineEntries(timeline);
    }

    function sortTimelineEntries(timeline) {
      const entries = Array.from(timeline.querySelectorAll('.timeline-entry'));
      entries.sort((a, b) => a.getAttribute('data-time').localeCompare(b.getAttribute('data-time')));
      entries.forEach(e => timeline.appendChild(e));
    }

    function sendShare() {
      const email = document.getElementById('shareEmail').value;
      if (!email) return alert("メールアドレスを入力してください");
      alert(`${email} にしおりを共有しました！`);
      closeShareModal();
    }
    function closeShareModal() {
      document.getElementById('shareModal').style.display = 'none';
      document.getElementById('shareEmail').value = '';
    }

    document.getElementById('shareButton').addEventListener('click', () => {
      document.getElementById('shareModal').style.display = 'block';
    });

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const date = params.get("date");
      const place = params.get("place");
      const trip_id = params.get("trip_id");
      console.log("trip_id:", trip_id);

      document.querySelector('.trip-title').textContent = `${date} in ${place}`;

      const match = date.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);
      if (match) {
        const [, , , start, end] = match.map(Number);
        const dayCount = end - start + 1;
        for (let i = 0; i < dayCount; i++) {
          const tab = document.createElement("div");
          tab.className = "tab" + (i === 0 ? " active" : "");
          tab.textContent = `${i + 1}日目`;
          tab.onclick = () => switchTab(i);
          tabsContainer.appendChild(tab);

          const content = document.createElement("div");
          content.className = "tab-content" + (i === 0 ? " active" : "");
          content.innerHTML = `<div class="shiori-box">
            <button class="edit-icon-button" data-tab="${i}" onclick="openAddModal(${i})">
              <img src="images/編集ボタン.png" class="edit-icon" alt="編集" width="40" height="40">
            </button>
            <div class="timeline"></div>
          </div>`;
          tabContentsContainer.appendChild(content);
        }
      }

      // ⬇️ dateパラメータから旅行開始・終了日を抽出
      const rawDate = params.get("date"); // 例: "2025.7.21-23"
      let startDate = null;
      let endDate = null;

      if (match) {
        const [, year, month, startDay, endDay] = match.map(Number);
        const start = new Date(year, month - 1, startDay);
        const end = new Date(year, month - 1, endDay);

        // 例: date = new Date(2025, 6, 21); // ← 月は0-indexed
        startDate = new Date(year, month - 1, startDay).toISOString().slice(0, 10);
        endDate = new Date(year, month - 1, endDay).toISOString().slice(0, 10);

      }

      // ✅ Supabaseから予定取得して表示（←ここに移動する！！）
      const { data: schedules, error: scheduleError } = await supabase
        .from("time_schedule")
        .select("*")
        .eq("trip_id", trip_id)
        .order("date", { ascending: true })


      console.log("旅行期間:", startDate, "〜", endDate);
      console.log("取得データ:", schedules);

      if (scheduleError) {
        console.error("予定の取得エラー:", scheduleError.message);
        alert("予定の取得に失敗しました");
        return;
      }

      schedules.forEach(entry => {
        const params = new URLSearchParams(location.search);
        const rawDate = params.get("date"); // 例: "2025.7.21-23"
        console.log("rawDate:", rawDate);
        const match = rawDate.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})-(\d{1,2})$/);

        let tabIndex = 0;
        if (match) {
          const [, year, month, startDay] = match.map(Number);

          // 🔽 修正: 日付をタイムゾーンなしでパース
          const [y, m, d] = entry.date.split("-").map(Number);
          const entryDate = new Date(y, m - 1, d);
          const baseDate = new Date(year, month - 1, startDay);
          
          tabIndex = Math.floor((entryDate - baseDate) / (1000 * 60 * 60 * 24));

          if (tabIndex < 0) return; // 範囲外はスキップ
        }
        entry.tabIndex = tabIndex;
        entry.desc = entry.location;
        entry.note = entry.description;
        renderSchedule(entry);
      });



      checkScheduleFeasibility(schedules);
    });


  </script>
</body>
</html>
